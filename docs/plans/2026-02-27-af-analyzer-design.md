# Af Analyzer æŠ€æœ¯è®¾è®¡æ–‡æ¡£

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** æ„å»ºåŸºäº YY/T 1771-2021 åˆ‡çº¿æ³•çš„äº¤äº’å¼å¥¥æ°ä½“ç›¸å˜æ¸©åº¦åˆ†æ Web å·¥å…·

**Architecture:** ä¸‰å±‚æ¶æ„ â€” Data I/O å±‚ï¼ˆå¤šæ ¼å¼åŠ è½½ï¼‰â†’ Core åˆ†æå¼•æ“ï¼ˆé¢„å¤„ç† + åˆ‡çº¿æ³•ç®—æ³•ï¼‰â†’ UI å±‚ï¼ˆStreamlit + Plotly äº¤äº’ï¼‰ï¼Œå¼•æ“ä¸ UI è§£è€¦ã€‚

**Tech Stack:** Python 3.10+, Streamlit, Plotly, Pandas, NumPy, SciPy, Matplotlib, openpyxl

---

## 1. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Streamlit UI                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Sidebar   â”‚  â”‚ Overview   â”‚  â”‚ Analysis     â”‚  â”‚
â”‚  â”‚ - Upload  â”‚  â”‚ Chart      â”‚  â”‚ Chart        â”‚  â”‚
â”‚  â”‚ - Channel â”‚  â”‚ (Plotly)   â”‚  â”‚ (Plotly)     â”‚  â”‚
â”‚  â”‚ - Smooth  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚ - Tangent â”‚                  â”‚ Results      â”‚  â”‚
â”‚  â”‚ - Export  â”‚                  â”‚ Panel        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Core Analysis Engine                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚preprocessing  â”‚  â”‚ tangent_analysis         â”‚  â”‚
â”‚  â”‚- group_by_tempâ”‚  â”‚ - compute_derivative     â”‚  â”‚
â”‚  â”‚- smooth_data  â”‚  â”‚ - find_max_slope_index   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ - fit_baseline           â”‚  â”‚
â”‚                    â”‚ - compute_tangent_at_pointâ”‚  â”‚
â”‚                    â”‚ - find_intersection       â”‚  â”‚
â”‚                    â”‚ - analyze_channel         â”‚  â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                Data I/O Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ data_loader   â”‚  â”‚ report_export            â”‚  â”‚
â”‚  â”‚ - load_json   â”‚  â”‚ - generate_analysis_fig  â”‚  â”‚
â”‚  â”‚ - load_excel  â”‚  â”‚ - export_excel_report    â”‚  â”‚
â”‚  â”‚ - load_csv    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”‚ - load_file   â”‚                               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. æ•°æ®æµ

```
åŸå§‹æ–‡ä»¶ (.json/.xlsx/.csv)
    â”‚
    â–¼
data_loader.load_file()
    â”‚ â†’ pd.DataFrame (Temperature, Space1~Space6)
    â”‚ â†’ valid_channels: list[str]
    â–¼
ç”¨æˆ·é€‰æ‹©é€šé“ (e.g. "Space1")
    â”‚
    â–¼
preprocessing.group_by_temperature(df, channel)
    â”‚ â†’ grouped_df (Temperature, Value) â€” å»é‡åçº¦ 30~50 ä¸ªæ¸©åº¦ç‚¹
    â–¼
preprocessing.smooth_data(temps, values, window, polyorder)
    â”‚ â†’ (smoothed_temps, smoothed_values)
    â–¼
tangent_analysis.analyze_channel(
    temps, values,
    low_range=(t_min, t_low),
    high_range=(t_high, t_max),
    smooth_params=(window, polyorder),
    slope_offset=0
)
    â”‚
    â”œâ†’ compute_derivative() â†’ derivatives
    â”œâ†’ find_max_slope_index(derivatives, offset) â†’ idx
    â”œâ†’ compute_tangent_at_point(temps, values, derivatives, idx) â†’ mid_tangent
    â”œâ†’ fit_baseline(temps, values, low_range) â†’ low_baseline
    â”œâ†’ fit_baseline(temps, values, high_range) â†’ high_baseline
    â”œâ†’ find_intersection(mid_tangent, low_baseline) â†’ As
    â”œâ†’ find_intersection(mid_tangent, high_baseline) â†’ Af_tan
    â”‚
    â–¼
è¿”å› AnalysisResult {
    As: float,
    Af_tan: float,
    mid_tangent: (slope, intercept),
    low_baseline: (slope, intercept),
    high_baseline: (slope, intercept),
    max_slope_temp: float,
    smoothed_temps: array,
    smoothed_values: array
}
    â”‚
    â–¼
UI æ¸²æŸ“å›¾è¡¨ + ç»“æœé¢æ¿
    â”‚
    â–¼ (ç”¨æˆ·ç‚¹å‡»å¯¼å‡º)
report_export â†’ PNG / Excel
```

## 3. æ ¸å¿ƒç®—æ³•è¯¦è§£

### 3.1 æŒ‰æ¸©åº¦åˆ†ç»„

åŸå§‹æ•°æ®çº¦ 10Hz é‡‡æ ·ï¼Œæ¸©åº¦å˜åŒ–ç¼“æ…¢ï¼ŒåŒä¸€æ¸©åº¦ä¸‹æœ‰å¤§é‡é‡å¤é‡‡æ ·ç‚¹ã€‚æŒ‰ `Temperature` åˆ—çš„å€¼è¿›è¡Œ `groupby().mean()`ï¼Œå¾—åˆ°æ¯ä¸ªç‹¬ç«‹æ¸©åº¦ç‚¹çš„å¹³å‡ä½ç§»å€¼ã€‚

æ¸©åº¦å€¼å¯èƒ½æœ‰æµ®ç‚¹ç²¾åº¦é—®é¢˜ï¼Œå¯è€ƒè™‘å››èˆäº”å…¥åˆ° 0.1Â°C ç²¾åº¦åå†åˆ†ç»„ï¼š
```python
df['Temperature'] = df['Temperature'].round(1)
```

### 3.2 Savitzky-Golay å¹³æ»‘

ä½¿ç”¨ `scipy.signal.savgol_filter`:
- `window_length`: æ»‘åŠ¨çª—å£å¤§å°ï¼Œå¿…é¡»ä¸ºå¥‡æ•°ã€‚å€¼è¶Šå¤§è¶Šå¹³æ»‘ä½†å¯èƒ½æŸå¤±ç»†èŠ‚ã€‚æ¨èé»˜è®¤ 51ã€‚
- `polyorder`: æ‹Ÿåˆå¤šé¡¹å¼é˜¶æ•°ã€‚å¿…é¡»å°äº window_lengthã€‚æ¨èé»˜è®¤ 3ã€‚

### 3.3 å¯¼æ•°è®¡ç®—

ä½¿ç”¨ `np.gradient(smoothed_values, smoothed_temps)` è®¡ç®—ä¸€é˜¶å¯¼æ•°ã€‚æ­¤æ–¹æ³•ä½¿ç”¨ä¸­å¿ƒå·®åˆ†ï¼Œè¾¹ç•Œä½¿ç”¨å‰å‘/åå‘å·®åˆ†ã€‚

### 3.4 æœ€å¤§æ–œç‡ç‚¹

```python
max_idx = np.argmax(np.abs(derivatives))
adjusted_idx = np.clip(max_idx + offset, 0, len(derivatives) - 1)
```

### 3.5 åˆ‡çº¿æ–¹ç¨‹

åœ¨ç´¢å¼• `idx` å¤„ï¼š
- æ–œç‡ = `derivatives[idx]`
- æˆªè· = `values[idx] - derivatives[idx] * temps[idx]`

### 3.6 åŸºå‡†çº¿æ‹Ÿåˆ

å¯¹æ¸©åº¦åŒºé—´ `[t_start, t_end]` å†…çš„æ•°æ®ç‚¹åšçº¿æ€§æœ€å°äºŒä¹˜æ‹Ÿåˆï¼š
```python
from scipy.stats import linregress
mask = (temps >= t_start) & (temps <= t_end)
slope, intercept, _, _, _ = linregress(temps[mask], values[mask])
```

### 3.7 äº¤ç‚¹è®¡ç®—

ä¸¤æ¡çº¿ `y = k1*x + b1` å’Œ `y = k2*x + b2`:
```python
if abs(k1 - k2) < 1e-10:
    return np.nan  # parallel
x_intersect = (b2 - b1) / (k1 - k2)
```

## 4. UI å¸ƒå±€è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”¬ å¥¥æ°ä½“ç›¸å˜æ¸©åº¦åˆ†æå·¥å…·                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SIDEBAR   â”‚  MAIN AREA                                 â”‚
â”‚            â”‚                                            â”‚
â”‚ â–¾ æ•°æ®åŠ è½½  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ [ä¸Šä¼ æ–‡ä»¶]  â”‚  â”‚    å¤šé€šé“æ€»è§ˆå›¾ (Plotly)               â”‚  â”‚
â”‚ é€šé“: [â–¼]  â”‚  â”‚    Temperature vs Space (all channels) â”‚  â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ â–¾ æ•°æ®é¢„å¤„ç†â”‚                                            â”‚
â”‚ çª—å£: [51] â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ é˜¶æ•°: [3]  â”‚  â”‚    å•é€šé“åˆ‡çº¿åˆ†æå›¾ (Plotly)            â”‚  â”‚
â”‚            â”‚  â”‚    å«ä¸‰æ¡åˆ‡çº¿ + As/Af æ ‡æ³¨              â”‚  â”‚
â”‚ â–¾ åˆ‡çº¿è°ƒæ•´  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚ ä½æ¸©:[â”€â—â”€] â”‚                                            â”‚
â”‚ é«˜æ¸©:[â”€â—â”€] â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚ åç§»:[â”€â—â”€] â”‚  â”‚As: 14.2â”‚  â”‚Af: 21.3â”‚  Â°C               â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚ â–¾ å¯¼å‡º     â”‚                                            â”‚
â”‚ [å¯¼å‡ºå›¾ç‰‡]  â”‚  åˆ†æå‚æ•°: çª—å£=51, é˜¶æ•°=3, ...            â”‚
â”‚ [å¯¼å‡ºæŠ¥å‘Š]  â”‚  [å¯¼å‡ºå›¾ç‰‡]  [å¯¼å‡ºæŠ¥å‘Š]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5. é»˜è®¤å‚æ•°ç­–ç•¥

| å‚æ•° | é»˜è®¤å€¼ | è®¡ç®—æ–¹å¼ |
|------|--------|---------|
| å¹³æ»‘çª—å£ | 51 | å›ºå®š |
| å¤šé¡¹å¼é˜¶æ•° | 3 | å›ºå®š |
| ä½æ¸©åŸºå‡†çº¿åŒºé—´ | æ•°æ®æ¸©åº¦èŒƒå›´çš„å‰ 15% | `(t_min, t_min + 0.15 * range)` |
| é«˜æ¸©åŸºå‡†çº¿åŒºé—´ | æ•°æ®æ¸©åº¦èŒƒå›´çš„å 15% | `(t_max - 0.15 * range, t_max)` |
| ä¸­é—´åˆ‡çº¿åç§» | 0 | æ— åç§»ï¼Œä½¿ç”¨è‡ªåŠ¨æ£€æµ‹ç‚¹ |

## 6. é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| ä¸Šä¼ æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ | `st.error` æç¤ºæ”¯æŒçš„æ ¼å¼ |
| æ–‡ä»¶å†…å®¹æ— æ³•è§£æ | `st.error` æ˜¾ç¤ºå…·ä½“é”™è¯¯ä¿¡æ¯ |
| æ‰€æœ‰é€šé“å‡ä¸º NaN | `st.warning` æç¤ºæ— æœ‰æ•ˆæ•°æ® |
| åŸºå‡†çº¿åŒºé—´å†…ç‚¹æ•° < 2 | `st.warning` æç¤ºè°ƒå¤§èŒƒå›´ |
| ä¸¤æ¡çº¿å¹³è¡Œæ— äº¤ç‚¹ | ç»“æœæ˜¾ç¤º NaNï¼Œ`st.warning` æç¤ºè°ƒæ•´å‚æ•° |
| å¹³æ»‘çª—å£ > æ•°æ®ç‚¹æ•° | è‡ªåŠ¨ç¼©å°çª—å£å¹¶ `st.info` æç¤º |

## 7. æ–‡ä»¶æ¸…å•ä¸ä¾èµ–å…³ç³»

```
app.py              â†’ ui/sidebar, ui/overview_chart, ui/analysis_chart, ui/results_panel
ui/sidebar.py       â†’ core/data_loader
ui/overview_chart.py â†’ (ä»…æ¥æ”¶ DataFrame)
ui/analysis_chart.py â†’ (ä»…æ¥æ”¶ AnalysisResult)
ui/results_panel.py  â†’ core/report_export
core/data_loader.py  â†’ pandas, numpy, pathlib
core/preprocessing.py â†’ scipy.signal.savgol_filter, numpy
core/tangent_analysis.py â†’ core/preprocessing, scipy.stats.linregress, numpy
core/report_export.py â†’ matplotlib, openpyxl, pandas
```
